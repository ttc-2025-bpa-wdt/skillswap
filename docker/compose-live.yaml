name: "skillswap"
services:
  backend:
    build:
      context: ./project/backend
      dockerfile: ./docker/Dockerfile
    hostname: backend.skillswap.internal
    restart: unless-stopped

  postgres:
    image: postgres:18.1-alpine
    hostname: postgres.skillswap.internal
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-skillswap}
      - POSTGRES_DB=${POSTGRES_DB:-skillswap_db}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - postgres-data:/var/lib/postgresql/data:rw
    ports:
      - "5432:5432"
    restart: unless-stopped

  nginx:
    image: nginx:alpine
    hostname: ${HOST:-skillswap.internal}
    environment:
      - HOST=${HOST:-skillswap.internal}
    volumes:
      - ./project/nginx/hosts/live.conf.template:/etc/nginx/conf.d/hosts/live.conf:ro
      - ./project/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    ports:
      - "${HOST_PORT:-80}:80"
    command: ["/bin/sh", "-c", "envsubst '$$HOST' < /etc/nginx/conf.d/hosts/live.conf > /etc/nginx/conf.d/hosts/live.conf && nginx -g 'daemon off;'"]
    restart: unless-stopped

volumes:
  postgres-data:
