server {
    server_name $HOST;

    listen 80;
    http2 on;

    # Serve static content at the following root
    root /srv/www/skillswap/live;

    # Static webpage serving
    location / {
        index index.html;
        try_files $uri $uri/ /index.html;

        # CDN caches for 5 seconds, browsers do not cache. Significantly reduces load on the server.
        add_header Cache-Control "public, max-age=0, s-maxage=5, stale-while-revalidate=5" always;
    }

    # GitHub webhook listener
    location /_github/ {
        proxy_pass http://127.0.0.1:7000;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
    }

    # Redirect API calls to the backend service
    location /api/ {
        set $upstream "backend.skillswap.internal.";
        proxy_pass http://$upstream:3000/api/;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
    }

    # Static website assets
    location /assets/ {
        try_files $uri $uri/ =404;

        # Cache static assets for 5 minutes on the CDN
        add_header Cache-Control "public, max-age=300, s-maxage=300" always;
        add_header Pragma "public" always;
        add_header Expires $expires_time;
    }

    # Multimedia files (images, videos, audio)
    location ~* \.(jpg|jpeg|png|gif|svg|webp|mp4|mp3|ogg|wav)$ {
        try_files $uri $uri/ =404;

        # Cache static assets for 5 minutes on the CDN
        add_header Cache-Control "public, max-age=300, s-maxage=300" always;
        add_header Pragma "public" always;
        add_header Expires $expires_time;
    }
}
