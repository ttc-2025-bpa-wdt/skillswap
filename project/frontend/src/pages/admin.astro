---
import GlobalLayout from "@layouts/global.astro";
import Button from "@components/base/Button.svelte";
import { Authentication, User, UserFilter } from "shared/models";
import { UserRole } from "shared/schema";
import { db } from "shared/helpers";

const token = Authentication.validateToken(Astro.request);
const currentUser = token ? await User.read(token.sub, UserFilter.Id) : null;

if (!currentUser || currentUser.role !== UserRole.Admin) {
    return Astro.redirect("/");
}

// Fetch all users with their profiles
const allUsers = await db.user.findMany({
    include: {
        profile: true
    },
    orderBy: {
        createdAt: 'desc'
    }
});

// Fetch all sessions
const allSessions = await db.session.findMany({
    orderBy: {
        eventDate: 'desc'
    }
});

const formatDate = (date: Date) => {
    return new Date(date).toLocaleDateString();
};
---

<GlobalLayout title="Admin Dashboard" user={currentUser}>
    <div class="admin-dashboard">
        <h1>Admin Dashboard</h1>
        
        <div class="tabs">
            <button class="tab-btn active" onclick="openTab(event, 'users')">Users</button>
            <button class="tab-btn" onclick="openTab(event, 'sessions')">Sessions</button>
        </div>

        <div id="users" class="tab-content active">
            <h2>User Management</h2>
            <div class="items-grid">
                {allUsers.map((user) => (
                    <div class="item-card">
                        <div class="item-header">
                            <span class="badg">{user.role}</span>
                            <h3>@{user.handle}</h3>
                        </div>
                        <div class="item-details">
                            <p><strong>ID:</strong> {user.id}</p>
                            <p><strong>Email:</strong> {user.email}</p>
                            <p><strong>Name:</strong> {user.firstName} {user.lastName}</p>
                            <p><strong>Display:</strong> {user.profile?.displayName || 'N/A'}</p>
                        </div>
                        <div class="item-actions">
                            <button class="btn-edit" onclick={`editUser('${user.handle}', ${JSON.stringify(user.profile).replace(/'/g, "&#39;")})`}>Edit</button>
                            <button class="btn-delete" onclick={`deleteUser('${user.handle}')`}>Delete</button>
                        </div>
                    </div>
                ))}
            </div>
        </div>

        <div id="sessions" class="tab-content">
            <h2>Session Management</h2>
            <div class="items-grid">
                {allSessions.map((session) => (
                    <div class="item-card">
                        <div class="item-header">
                            <h3>{session.name}</h3>
                        </div>
                        <div class="item-details">
                            <p><strong>ID:</strong> {session.id}</p>
                            <p><strong>Date:</strong> {formatDate(session.eventDate)}</p>
                            <p><strong>Difficulty:</strong> {session.difficulty}</p>
                            <p><strong>Categories:</strong> {session.categories}</p>
                        </div>
                        <div class="item-actions">
                            <button class="btn-edit" onclick={`editSession(${JSON.stringify(session).replace(/'/g, "&#39;")})`}>Edit</button>
                            <button class="btn-delete" onclick={`deleteSession('${session.id}')`}>Delete</button>
                        </div>
                    </div>
                ))}
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <dialog id="editUserModal">
        <form method="dialog" id="editUserForm">
            <h3>Edit User</h3>
            <input type="hidden" name="handle" id="edit_user_handle" />
            
            <label>
                Display Name:
                <input type="text" name="displayName" id="edit_user_displayName" />
            </label>
            <label>
                Avatar URL:
                <input type="text" name="avatarUrl" id="edit_user_avatarUrl" />
            </label>
            <label>
                Bio:
                <textarea name="bio" id="edit_user_bio"></textarea>
            </label>
            <label>
                Tags (comma separated):
                <input type="text" name="tags" id="edit_user_tags" />
            </label>
            <label>
                Skills (comma separated):
                <input type="text" name="skills" id="edit_user_skills" />
            </label>

            <div class="modal-actions">
                <button type="button" onclick="closeModal('editUserModal')">Cancel</button>
                <button type="submit">Save</button>
            </div>
        </form>
    </dialog>

    <!-- Edit Session Modal -->
    <dialog id="editSessionModal">
        <form method="dialog" id="editSessionForm">
            <h3>Edit Session</h3>
            <input type="hidden" name="id" id="edit_session_id" />
            
            <label>
                Name:
                <input type="text" name="name" id="edit_session_name" />
            </label>
            <label>
                Categories (comma separated):
                <input type="text" name="categories" id="edit_session_categories" />
            </label>
            <label>
                Prerequisites:
                <textarea name="prereqs" id="edit_session_prereqs"></textarea>
            </label>
            <label>
                Difficulty:
                <select name="difficulty" id="edit_session_difficulty">
                    <option value="Beginner">Beginner</option>
                    <option value="Intermediate">Intermediate</option>
                    <option value="Advanced">Advanced</option>
                </select>
            </label>
            <label>
                Event Date:
                <input type="datetime-local" name="eventDate" id="edit_session_eventDate" />
            </label>

            <div class="modal-actions">
                <button type="button" onclick="closeModal('editSessionModal')">Cancel</button>
                <button type="submit">Save</button>
            </div>
        </form>
    </dialog>

</GlobalLayout>

<script is:inline>
    // Tab switching
    window.openTab = function(evt, tabName) {
        var i, tabcontent, tabbuttons;
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
            tabcontent[i].classList.remove("active");
        }
        tabbuttons = document.getElementsByClassName("tab-btn");
        for (i = 0; i < tabbuttons.length; i++) {
            tabbuttons[i].classList.remove("active");
        }
        document.getElementById(tabName).style.display = "block";
        document.getElementById(tabName).classList.add("active");
        evt.currentTarget.classList.add("active");
    }

    // Modal helpers
    window.closeModal = function(id) {
        document.getElementById(id).close();
    }

    // --- User Actions ---

    window.deleteUser = async function(handle) {
        if (!confirm(`Are you sure you want to delete user @${handle}?`)) return;

        try {
            const res = await fetch(`/api/v1/user?handle=${handle}`, {
                method: 'DELETE',
            });
            const data = await res.json();
            if (data.success) {
                alert('User deleted successfully');
                window.location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        } catch (e) {
            alert('Request failed');
        }
    }

    window.editUser = function(handle, profile) {
        profile = profile || {};
        document.getElementById('edit_user_handle').value = handle;
        document.getElementById('edit_user_displayName').value = profile.displayName || '';
        document.getElementById('edit_user_avatarUrl').value = profile.avatarUrl || '';
        document.getElementById('edit_user_bio').value = profile.bio || '';
        
        // Tags/Skills could be arrays or strings in DB, checking assumption
        // The API expects arrays, but we transmit as JSON.
        // Assuming the `profile` object passed here is from Prisma.
        // Prisma stores JSON as string mostly if using sqlite/simple types, or actual JSON object.
        // The DOCS says "API expects JSON body values" for tags.
        // In the UI form we use comma separated strings.
        
        let tags = profile.tags;
        if (typeof tags === 'string') {
            try { tags = JSON.parse(tags); } catch(e) {}
        }
        document.getElementById('edit_user_tags').value = Array.isArray(tags) ? tags.join(', ') : (tags || '');

        let skills = profile.skills;
        if (typeof skills === 'string') {
            try { skills = JSON.parse(skills); } catch(e) {}
        }
        document.getElementById('edit_user_skills').value = Array.isArray(skills) ? skills.join(', ') : (skills || '');

        document.getElementById('editUserModal').showModal();
    }

    document.getElementById('editUserForm').onsubmit = async function(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        
        const tagsStr = formData.get('tags');
        const tags = tagsStr ? tagsStr.split(',').map(s => s.trim()).filter(Boolean) : [];

        const skillsStr = formData.get('skills');
        const skills = skillsStr ? skillsStr.split(',').map(s => s.trim()).filter(Boolean) : [];

        const payload = {
            handle: formData.get('handle'),
            displayName: formData.get('displayName'),
            avatarUrl: formData.get('avatarUrl'),
            bio: formData.get('bio'),
            tags: tags,
            skills: skills
        };

        try {
            const res = await fetch('/api/v1/user', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (data.success) {
                alert('User updated');
                window.location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        } catch (e) {
            alert('Request failed');
        }
    }


    // --- Session Actions ---

    window.deleteSession = async function(id) {
        if (!confirm(`Delete session ${id}?`)) return;

        try {
            const res = await fetch('/api/v1/session', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id }) 
            });
            const data = await res.json();
            if (data.success) {
                alert('Session deleted');
                window.location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        } catch (e) {
            alert('Request failed');
        }
    }

    window.editSession = function(session) {
        document.getElementById('edit_session_id').value = session.id;
        document.getElementById('edit_session_name').value = session.name;
        document.getElementById('edit_session_prereqs').value = session.prereqs || '';
        document.getElementById('edit_session_difficulty').value = session.difficulty;
        
        // Date handling
        // session.eventDate is likely ISO string or Date object from JSON
        if (session.eventDate) {
            try {
                // Input datetime-local needs YYYY-MM-DDThh:mm
                const d = new Date(session.eventDate);
                // Adjust for timezone offset for input value
                const localIso = new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
                document.getElementById('edit_session_eventDate').value = localIso;
            } catch(e) {}
        }

        let cats = session.categories;
        if (typeof cats === 'string') {
           try { cats = JSON.parse(cats); } catch(e) {}
        }
        document.getElementById('edit_session_categories').value = Array.isArray(cats) ? cats.join(', ') : (cats || '');

        document.getElementById('editSessionModal').showModal();
    }

    document.getElementById('editSessionForm').onsubmit = async function(e) {
        e.preventDefault();
        const formData = new FormData(e.target);

        const catsStr = formData.get('categories');
        const categories = catsStr ? catsStr.split(',').map(s => s.trim()).filter(Boolean) : [];

        const payload = {
            id: formData.get('id'),
            name: formData.get('name'),
            prereqs: formData.get('prereqs'),
            difficulty: formData.get('difficulty'),
            eventDate: new Date(formData.get('eventDate')).toISOString(),
            categories: categories
        };

        try {
            const res = await fetch('/api/v1/session', {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (data.success) {
                alert('Session updated');
                window.location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        } catch (e) {
            alert('Request failed');
        }
    }
</script>

<style lang="scss">
    .admin-dashboard {
        padding: 2rem;
        max-width: 1200px;
        margin: 0 auto;

        .tabs {
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--accent-3);
            
            button {
                background: none;
                border: none;
                padding: 1rem 2rem;
                font-size: 1.1rem;
                cursor: pointer;
                color: var(--foreground);
                
                &.active {
                    border-bottom: 2px solid var(--accent-1);
                    color: var(--accent-1);
                    font-weight: bold;
                    margin-bottom: -2px;
                }
            }
        }

        .tab-content {
            display: none;
            &.active {
                display: block;
            }
        }
    }

    .items-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1.5rem;
    }

    .item-card {
        background: var(--card-bg);
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border: 1px solid var(--accent-3);
        display: flex;
        flex-direction: column;
        gap: 0.5rem;

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            h3 { margin: 0; font-size: 1.2rem; }
            .badg {
                font-size: 0.8rem;
                background: var(--accent-3);
                padding: 0.2rem 0.5rem;
                border-radius: 4px;
            }
        }

        .item-details {
            font-size: 0.9rem;
            color: var(--foreground-muted);
            p { margin: 0.2rem 0; word-break: break-word; }
        }

        .item-actions {
            margin-top: auto;
            padding-top: 1rem;
            display: flex;
            gap: 1rem;
            
            button {
                flex: 1;
                padding: 0.5rem;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                
                &.btn-edit { background: var(--secondary); color: white; }
                &.btn-delete { background: var(--error, #e74c3c); color: white; }
            }
        }
    }

    dialog {
        padding: 2rem;
        border: none;
        border-radius: 8px;
        background: var(--card-bg);
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        max-width: 500px;
        width: 90%;
        color: var(--foreground);

        &::backdrop {
            background: rgba(0,0,0,0.5);
        }

        form {
            display: flex;
            flex-direction: column;
            gap: 1rem;

            label {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
                font-weight: 500;
            }

            input, textarea, select {
                padding: 0.5rem;
                border: 1px solid var(--accent-3);
                border-radius: 4px;
                background: var(--background);
                color: var(--foreground);
            }

            textarea { min-height: 100px; }

            .modal-actions {
                display: flex;
                justify-content: flex-end;
                gap: 1rem;
                margin-top: 1rem;
                
                button {
                    padding: 0.5rem 1.5rem;
                    cursor: pointer;
                    border: none;
                    border-radius: 4px;
                    
                    &[type="submit"] { background: var(--primary); color: white; }
                    &[type="button"] { background: var(--secondary); color: white; }
                }
            }
        }
    }
</style>
