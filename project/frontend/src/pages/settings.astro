---
import { Authentication, Profile, ProfileFilter, User, UserFilter } from "shared/models";

import Layout from "@layouts/global.astro";
import Button from "@components/base/Button.svelte";
import Card from "@components/base/Card.astro";

const token = Authentication.validateToken(Astro.request);
if (!token) return Astro.redirect("/auth/login");

const user = await User.read(token.sub, UserFilter.Id);
if (!user) return Astro.redirect("/auth/login");

const profile = await Profile.read(user.profileId, ProfileFilter.Id);
if (!profile) return Astro.redirect("/"); // todo: handle this server error
---

<Layout title="Settings" desc="Manage your account settings">
    <div class="settings-container">
        <header class="page-header">
            <h1>Account Settings</h1>
            <p>Manage your profile details and account security</p>
        </header>

        <div class="settings-grid">
            <!-- Profile Section -->
            <section class="settings-section">
                <h2 class="section-heading">Public Profile</h2>
                <Card class="settings-card">
                    <form id="profile-form">
                        <div class="avatar-row">
                            <div class="avatar-current">
                                <img src={profile.avatarUrl} alt={profile.displayName} />
                            </div>
                            <div class="avatar-info">
                                <h3>Profile Picture</h3>
                                <div class="avatar-actions">
                                    <Button size="sm" variant="secondary" type="button">Upload New</Button>
                                    <Button size="sm" variant="ghost" type="button" class="text-danger">Remove</Button>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="name">Display Name</label>
                            <input
                                type="text"
                                id="name"
                                name="name"
                                value={profile.displayName}
                                placeholder="Your name"
                            />
                        </div>

                        <div class="form-group">
                            <label for="handle">Handle</label>
                            <input type="text" id="handle" value={user.handle} disabled class="disabled-input" />
                            <p class="helper-text">Handles cannot be changed once set.</p>
                        </div>

                        <div class="form-group">
                            <label for="bio">Bio</label>
                            <textarea id="bio" rows="3" placeholder="Tell us a little about yourself"
                                >{profile.bio}</textarea
                            >
                        </div>

                        <div class="form-footer">
                            <Button type="submit">Save Changes</Button>
                        </div>
                    </form>
                </Card>
            </section>

            <!-- Account Section -->
            <section class="settings-section">
                <h2 class="section-heading">Account Security</h2>
                <Card class="settings-card">
                    <form id="account-form">
                        <div class="form-group">
                            <label for="email">Email Address</label>
                            <input type="email" id="email" name="email" value={user.email} />
                        </div>

                        <div class="form-group">
                            <label>Password</label>
                            <div class="password-actions">
                                <div class="password-boxes">
                                    <input type="password" placeholder="New Password" />
                                    <input type="password" placeholder="Current Password" />
                                </div>
                                <div class="password-buttons">
                                    <Button type="button" variant="secondary">Change Password</Button>
                                    <Button type="button" variant="outline">Forgot Password?</Button>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Member Since</label>
                            <div class="readonly-value">{user.createdAt}</div>
                        </div>

                        <div class="form-footer">
                            <Button type="submit">Update Email</Button>
                        </div>
                    </form>
                </Card>
            </section>

            <!-- Danger Zone -->
            <section class="settings-section">
                <h2 class="section-heading text-danger">Danger Zone</h2>
                <Card class="settings-card danger-zone">
                    <div class="danger-item">
                        <div class="danger-info">
                            <h3>Sign Out</h3>
                            <p>Sign out of your account on this device.</p>
                        </div>
                        <Button variant="outline" class="btn-danger" type="button" href="/auth/logout">Sign Out</Button>
                    </div>
                    <div class="danger-item">
                        <div class="danger-info">
                            <h3>Delete Account</h3>
                            <p>Permanently delete your account and all of your content.</p>
                        </div>
                        <Button
                            variant="outline"
                            class="btn-danger"
                            type="button"
                            onclick="confirm('Are you surely you want to delete your account? This action cannot be undone.')"
                            >Delete Account</Button
                        >
                    </div>
                </Card>
            </section>
        </div>
    </div>
</Layout>

<style lang="scss">
    .settings-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 2rem 1rem 4rem;
    }

    .page-header {
        margin-bottom: 2rem;

        h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        p {
            opacity: 0.7;
            font-size: 1.1rem;
        }
    }

    .settings-section {
        margin-bottom: 2.5rem;
    }

    .section-heading {
        font-size: 1.25rem;
        margin-bottom: 1rem;
        font-weight: 600;

        &.text-danger {
            color: #d32f2f;
        }
    }

    .settings-card {
        @media (max-width: 600px) {
            padding: 1.5rem;
        }
    }

    /* Form Styles */
    .form-group {
        margin-bottom: 1.5rem;

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        input,
        textarea {
            width: 100%;
            /* Theme overrides */
            padding: 0.75rem 1rem;
            border-radius: 6px;

            &.disabled-input {
                background-color: rgba(0, 0, 0, 0.05);
                color: rgba(0, 0, 0, 0.6);
                cursor: not-allowed;
            }
        }

        .helper-text {
            display: block;
            margin-top: 0.35rem;
            font-size: 0.85rem;
            opacity: 0.7;
        }
    }

    .readonly-value {
        padding: 0.75rem 0;
        color: var(--foreground);
        font-size: 1rem;
        border-bottom: 1px solid var(--accent-3);
        width: 100%;
    }

    .form-footer {
        margin-top: 2rem;
        display: flex;
        justify-content: flex-end;
    }

    /* Avatar Section */
    .avatar-row {
        display: flex;
        align-items: center;
        gap: 1.5rem;
        margin-bottom: 2rem;
        padding-bottom: 2rem;
        border-bottom: 1px solid var(--accent-3);

        @media (max-width: 600px) {
            flex-direction: column;
            text-align: center;
        }

        .avatar-current {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            overflow: hidden;
            border: 3px solid var(--background);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;

            img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }
        }

        .avatar-info {
            h3 {
                margin: 0 0 0.5rem;
                font-size: 1.1rem;
            }

            .avatar-actions {
                display: flex;
                gap: 0.5rem;

                @media (max-width: 600px) {
                    justify-content: center;
                }
            }
        }
    }

    .text-danger {
        color: #d32f2f !important;
        border-color: #d32f2f !important;

        &:hover {
            background-color: rgba(211, 47, 47, 0.05);
        }
    }

    .password-actions {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .password-boxes {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;

        input {
            flex: 1;
        }
    }

    .password-buttons {
        display: flex;
        gap: 0.5rem;

        button {
            flex: 1;
        }

        @media (max-width: 600px) {
            justify-content: center;
        }
    }

    /* Danger Zone */
    .danger-zone {
        display: flex;
        flex-direction: column;
        gap: 2rem;
        border: 1px solid rgba(211, 47, 47, 0.3);
        background: rgba(211, 47, 47, 0.02);
    }

    .danger-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 2rem;

        @media (max-width: 600px) {
            flex-direction: column;
            text-align: center;
            align-items: stretch;
        }

        .danger-info {
            h3 {
                margin: 0 0 0.5rem;
                font-size: 1.1rem;
                font-weight: 600;
            }
            p {
                margin: 0;
                font-size: 0.9rem;
                opacity: 0.7;
            }
        }
    }

    // Scoped button override for danger button
    :global(.btn-danger) {
        color: #d32f2f !important;
        border-color: #d32f2f !important;

        &:hover {
            background-color: #d32f2f !important;
            color: white !important;
        }
    }
</style>

<script>
    // Form handling simulation
    const profileForm = document.getElementById("profile-form");
    const accountForm = document.getElementById("account-form");

    profileForm?.addEventListener("submit", (e) => {
        e.preventDefault();
        const btn = profileForm.querySelector('button[type="submit"]');
        if (btn) {
            const originalText = btn.textContent;
            btn.textContent = "Saving...";
            // Simulate API call
            setTimeout(() => {
                btn.textContent = "Saved!";
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            }, 800);
        }
    });

    accountForm?.addEventListener("submit", (e) => {
        e.preventDefault();
        alert("Email update functionality to be implemented.");
    });
</script>
