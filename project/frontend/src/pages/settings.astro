---
import { Authentication, Profile, ProfileFilter, User, UserFilter } from "shared/models";

import Layout from "@layouts/global.astro";
import Button from "@components/base/Button.svelte";
import Card from "@components/base/Card.svelte";

const token = Authentication.validateToken(Astro.request);
if (!token) return Astro.redirect("/auth/login");

const user = await User.read(token.sub, UserFilter.Id);
if (!user) return Astro.redirect("/auth/login");

const profile = await Profile.read(user.profileId, ProfileFilter.Id);

const tagsList = profile?.tags;
const tagsValue = Array.isArray(tagsList) ? tagsList.join(", ") : "";

const skillsList = profile?.skills;
const skillsValue = Array.isArray(skillsList) ? skillsList.join(", ") : "";
---

<Layout title="Settings" desc="Manage your account settings">
    <div class="settings-container">
        <header class="page-header">
            <h1>Account Settings</h1>
            <p>Manage your profile details and account security</p>
        </header>

        <div class="settings-grid">
            <!-- Profile Section -->
            {profile && <section class="settings-section">
                <h2 class="section-heading">Public Profile</h2>
                <Card class="settings-card">
                    <form id="profile-form">
                        <input type="hidden" name="avatarUrl" id="avatar-url-input" value={profile.avatarUrl} />
                        <div class="avatar-row">
                            <div class="avatar-current">
                                <img src={profile.avatarUrl} alt={profile.displayName} />
                            </div>
                            <div class="avatar-info">
                                <h3>Profile Picture</h3>
                                <div class="avatar-actions">
                                    <input type="file" id="avatar-upload" accept="image/png, image/jpeg" style="display:none" />
                                    <Button size="sm" variant="secondary" id="btn-upload-avatar" type="button">Upload New</Button>
                                    <Button size="sm" variant="ghost" class="text-danger" id="btn-remove-avatar" type="button">Remove</Button>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="name">Display Name</label>
                            <input
                                type="text"
                                id="name"
                                name="name"
                                value={profile.displayName}
                                placeholder="Your name"
                            />
                        </div>

                        <div class="form-group">
                            <label for="handle">Handle</label>
                            <input type="text" id="handle" value={user.handle} disabled class="disabled-input" />
                            <p class="helper-text">Handles cannot be changed once set.</p>
                        </div>

                        <div class="form-group">
                            <label for="bio">Bio</label>
                            <textarea id="bio" name="bio" rows="3" placeholder="Tell us a little about yourself"
                                >{profile.bio}</textarea
                            >
                        </div>

                        <div class="form-group">
                            <label for="tags">Skills Offered</label>
                            <input
                                type="text"
                                id="tags"
                                name="tags"
                                value={tagsValue}
                                placeholder="e.g. Mathematics, Piano, Coding"
                            />
                            <p class="helper-text">Comma-separated list of skills you can teach.</p>
                        </div>

                        <div class="form-group">
                            <label for="skills">Skills Sought</label>
                            <input
                                type="text"
                                id="skills"
                                name="skills"
                                value={skillsValue}
                                placeholder="e.g. Cooking, Spanish, Guitar"
                            />
                            <p class="helper-text">Comma-separated list of skills you want to learn.</p>
                        </div>

                        <div class="form-footer">
                            <Button type="submit">Save Changes</Button>
                        </div>
                    </form>
                </Card>
            </section>}

            <!-- Account Section -->
            <section class="settings-section">
                <h2 class="section-heading">Account Security</h2>
                <Card class="settings-card">
                    <form id="account-form">
                        <div class="form-group">
                            <label for="email">Email Address</label>
                            <input type="email" id="email" name="email" value={user.email} />
                        </div>

                        <div class="form-group">
                            <label>Password</label>
                            <div class="password-actions">
                                <div class="password-boxes">
                                    <input type="password" placeholder="New Password" />
                                    <input type="password" placeholder="Current Password" />
                                </div>
                                <div class="password-buttons">
                                    <Button variant="secondary">Change Password</Button>
                                    <Button variant="outline">Forgot Password?</Button>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Member Since</label>
                            <div class="readonly-value">{user.createdAt}</div>
                        </div>

                        <div class="form-footer">
                            <Button>Update Email</Button>
                        </div>
                    </form>
                </Card>
            </section>

            <!-- Danger Zone -->
            <section class="settings-section">
                <h2 class="section-heading text-danger">Danger Zone</h2>
                <Card class="settings-card danger-zone">
                    <div class="danger-item">
                        <div class="danger-info">
                            <h3>Sign Out</h3>
                            <p>Sign out of your account on this device.</p>
                        </div>
                        <Button variant="outline" class="btn-danger" href="/auth/logout">Sign Out</Button>
                    </div>
                    <div class="danger-item">
                        <div class="danger-info">
                            <h3>Delete Account</h3>
                            <p>Permanently delete your account and all of your content.</p>
                        </div>
                        <Button variant="outline" class="btn-danger" id="btn-delete-account">Delete Account</Button>
                    </div>
                </Card>
            </section>
        </div>
    </div>
</Layout>

<style lang="scss">
    .settings-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 2rem 1rem 4rem;
    }

    .page-header {
        margin-bottom: 2rem;

        h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        p {
            opacity: 0.7;
            font-size: 1.1rem;
        }
    }

    .settings-section {
        margin-bottom: 2.5rem;
    }

    .section-heading {
        font-size: 1.25rem;
        margin-bottom: 1rem;
        font-weight: 600;

        &.text-danger {
            color: #d32f2f;
        }
    }

    .settings-card {
        @media (max-width: 600px) {
            padding: 1.5rem;
        }
    }

    /* Form Styles */
    .form-group {
        margin-bottom: 1.5rem;

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        input,
        textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 6px;

            &.disabled-input {
                background-color: rgba(0, 0, 0, 0.05);
                color: rgba(0, 0, 0, 0.6);
                cursor: not-allowed;
            }
        }

        .helper-text {
            display: block;
            margin-top: 0.35rem;
            font-size: 0.85rem;
            opacity: 0.7;
        }
    }

    .readonly-value {
        padding: 0.75rem 0;
        color: var(--foreground);
        font-size: 1rem;
        border-bottom: 1px solid var(--accent-3);
        width: 100%;
    }

    .form-footer {
        margin-top: 2rem;
        display: flex;
        justify-content: flex-end;
    }

    /* Avatar Section */
    .avatar-row {
        display: flex;
        align-items: center;
        gap: 1.5rem;
        margin-bottom: 2rem;
        padding-bottom: 2rem;
        border-bottom: 1px solid var(--accent-3);

        @media (max-width: 600px) {
            flex-direction: column;
            text-align: center;
        }

        .avatar-current {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            overflow: hidden;
            border: 3px solid var(--background);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;

            img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }
        }

        .avatar-info {
            h3 {
                margin: 0 0 0.5rem;
                font-size: 1.1rem;
            }

            .avatar-actions {
                display: flex;
                gap: 0.5rem;

                @media (max-width: 600px) {
                    justify-content: center;
                }
            }
        }
    }

    .text-danger {
        color: #d32f2f !important;
        border-color: #d32f2f !important;

        &:hover {
            background-color: rgba(211, 47, 47, 0.05);
        }
    }

    .password-actions {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .password-boxes {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;

        input {
            flex: 1;
        }
    }

    .password-buttons {
        display: flex;
        gap: 0.5rem;

        button {
            flex: 1;
        }

        @media (max-width: 600px) {
            justify-content: center;
        }
    }

    /* Danger Zone */
    .danger-zone {
        display: flex;
        flex-direction: column;
        gap: 2rem;
        border: 1px solid rgba(211, 47, 47, 0.3);
        background: rgba(211, 47, 47, 0.02);
    }

    .danger-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 2rem;

        @media (max-width: 600px) {
            flex-direction: column;
            text-align: center;
            align-items: stretch;
        }

        .danger-info {
            h3 {
                margin: 0 0 0.5rem;
                font-size: 1.1rem;
                font-weight: 600;
            }
            p {
                margin: 0;
                font-size: 0.9rem;
                opacity: 0.7;
            }
        }
    }

    // Scoped button override for danger button
    :global(.btn-danger) {
        color: #d32f2f !important;
        border-color: #d32f2f !important;

        &:hover {
            background-color: #d32f2f !important;
            color: white !important;
        }
    }
</style>

<script>
    // Form handling
    const profileForm = document.getElementById("profile-form") as HTMLFormElement;
    const accountForm = document.getElementById("account-form");

    // Avatar handling
    const avatarInput = document.getElementById("avatar-upload") as HTMLInputElement;
    const uploadBtn = document.getElementById("btn-upload-avatar");
    const removeBtn = document.getElementById("btn-remove-avatar");
    const avatarUrlInput = document.getElementById("avatar-url-input") as HTMLInputElement;
    const avatarImg = document.querySelector(".avatar-current img") as HTMLImageElement;

    uploadBtn?.addEventListener("click", () => avatarInput?.click());

    removeBtn?.addEventListener("click", () => {
        if (confirm("Reset avatar to default?")) {
            const defaultUrl = "/images/avatar/default.png";
            if (avatarImg) avatarImg.src = defaultUrl;
            if (avatarUrlInput) avatarUrlInput.value = defaultUrl;
        }
    });

    avatarInput?.addEventListener("change", async () => {
        const file = avatarInput.files?.[0];
        if (!file) return;
        
        if (file.size > 5 * 1024 * 1024) {
            alert("File is too large (max 5MB)");
            return;
        }

        const originalText = uploadBtn!.textContent;
        if (uploadBtn) uploadBtn.textContent = "Uploading...";

        try {
            const res = await fetch("/api/v1/user/avatar", {
                method: "POST",
                headers: { "Content-Type": file.type },
                body: file
            });
            const result = await res.json();
            
            if (result.success) {
                const url = result.data.url;
                if (avatarImg) avatarImg.src = `${url}?v=${Date.now()}`;
                if (avatarUrlInput) avatarUrlInput.value = url;
            } else {
                alert(result.error || "Upload failed");
            }
        } catch (err) {
            console.error(err);
            alert("Upload failed");
        } finally {
            if (uploadBtn) uploadBtn.textContent = originalText;
            avatarInput.value = ""; 
        }
    });

    profileForm?.addEventListener("submit", async (e) => {
        e.preventDefault();
        const btn = profileForm.querySelector('button[type="submit"]');
        if (btn) {
            const originalText = btn.textContent;
            btn.textContent = "Saving...";
            
            const formData = new FormData(profileForm);
            
            try {
                const res = await fetch('/api/v1/user', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        displayName: formData.get('name'),
                        bio: formData.get('bio'),
                        avatarUrl: formData.get('avatarUrl'),
                        tags: (formData.get('tags') as string || "").split(",").map(s => s.trim()).filter(Boolean),
                        skills: (formData.get('skills') as string || "").split(",").map(s => s.trim()).filter(Boolean)
                    })
                });

                const result = await res.json();
                if (result.success) {
                    btn.textContent = "Saved!";
                    setTimeout(() => {
                        btn.textContent = originalText;
                    }, 2000);
                } else {
                    btn.textContent = originalText;
                    alert(result.error);
                }
            } catch (err) {
                console.error(err);
                btn.textContent = originalText;
                alert("Error saving settings");
            }
        }
    });

    accountForm?.addEventListener("submit", (e) => {
        e.preventDefault();
        alert("Email update functionality to be implemented.");
    });

    // Delete Account
    const deleteAccountBtn = document.getElementById("btn-delete-account");
    deleteAccountBtn?.addEventListener("click", async () => {
        if (confirm("Are you sure you want to permanently delete your account? This action cannot be undone.")) {
             const originalText = deleteAccountBtn.textContent;
             deleteAccountBtn.textContent = "Deleting...";
             try {
                 const res = await fetch("/api/v1/user", {
                     method: "DELETE",
                     headers: { 'Content-Type': 'application/json' }
                 });
                 const result = await res.json();
                 if (result.success) {
                     alert("Account deleted.");
                     window.location.href = "/";
                 } else {
                     alert(result.error || "Failed to delete account");
                     deleteAccountBtn.textContent = originalText;
                 }
             } catch (err) {
                 console.error(err);
                 alert("Request failed");
                 deleteAccountBtn.textContent = originalText;
             }
        }
    });
</script>
