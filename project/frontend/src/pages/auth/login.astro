---
import Layout from "@layouts/global.astro";
import Card from "@components/base/Card.svelte";
import Button from "@components/base/Button.svelte";
import "@styles/auth.scss";
---

<Layout title="Log In">
    <div class="auth-container">
        <Card class="auth-card narrow">
            <h1>Welcome Back</h1>
            <p class="subtitle">Sign in to continue to SkillSwap</p>

            <div
                id="client-error"
                class="error-message"
                style="display: none; margin-bottom: 1rem; text-align: center;"
            >
            </div>

            <form id="login-form" novalidate>
                <div class="form-group">
                    <label for="emailOrHandle">Email or Handle</label>
                    <input type="text" name="emailOrHandle" placeholder="Email or handle" required />
                </div>

                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" name="password" placeholder="Password" required minlength="8" />
                </div>

                <div class="form-options">
                    <label class="checkbox-container">
                        <input type="checkbox" name="remember" />
                        <span>Remember me</span>
                    </label>
                    <a href="/auth/forgot-password" class="forgot-password">Forgot Password?</a>
                </div>

                <Button type="submit" variant="primary" block>Log In</Button>
            </form>

            <script>
                import { showAlert } from "@lib/ui";

                const form = document.getElementById("login-form") as HTMLFormElement;
                const errorDiv = document.getElementById("client-error");

                form?.addEventListener("submit", async (e) => {
                    e.preventDefault();
                    if (errorDiv) errorDiv.style.display = "none";

                    const formData = new FormData(form);
                    const emailOrHandle = formData.get("emailOrHandle");
                    const password = formData.get("password");
                    const remember = formData.get("remember") === "on";

                    try {
                        const res = await fetch("/api/v1/auth/login", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ emailOrHandle, password, remember }),
                        });

                        const result = await res.json();

                        if (result.success) {
                            window.location.href = "/dashboard";
                        } else {
                            if (errorDiv) {
                                errorDiv.innerText = result.error || "Login failed";
                                errorDiv.style.display = "block";
                            } else {
                                await showAlert(result.error || "Login failed", "Error");
                            }
                        }
                    } catch (err) {
                        console.error(err);
                        if (errorDiv) {
                            errorDiv.innerText = "Connection error";
                            errorDiv.style.display = "block";
                        }
                    }
                });
            </script>

            <p class="register-link">
                Don't have an account? <a href="/auth/register">Create Account</a>
            </p>
        </Card>
    </div>
</Layout>

<style lang="scss">
    .forgot-password {
        color: var(--accent-1);
        text-decoration: none;
        font-weight: 500;

        &:hover {
            text-decoration: underline;
        }
    }
</style>
