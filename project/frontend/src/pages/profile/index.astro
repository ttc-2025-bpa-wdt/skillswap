---
import Layout from "@layouts/global.astro";
import Button from "@components/Button.astro";
import Card from "@components/Card.astro";

// Mock Data
const user = {
    name: "Jordan Lee",
    username: "@jlee_dev",
    avatar: "/images/jordan-lee.png",
    bio: "Computer Science student passionate about web development and AI. Love teaching Python and learning guitar.",
    role: "Student & Mentor",
    skills: ["Python", "JavaScript", "React", "Guitar", "Math"],
    badges: ["Top Mentor", "Early Adopter", "Code Wizard"],
    stats: {
        sessions: 42,
        rating: 4.8,
        students: 15
    },
    sessions: [
        { id: 1, title: "Intro to React", date: "2025-12-05", time: "14:00", type: "Teaching", status: "Upcoming" },
        { id: 2, title: "Guitar Basics", date: "2025-12-02", time: "16:00", type: "Learning", status: "Completed" }
    ],
    reviews: [
        { id: 1, user: "Alex K.", rating: 5, comment: "Great explanation of hooks!", date: "2025-11-20" },
        { id: 2, user: "Sam R.", rating: 4, comment: "Very patient.", date: "2025-11-15" }
    ],
    settings: {
        privacy: true, // true = public
        notifications: true
    }
};
---

<Layout title={`${user.name} | Profile`} desc={`Profile of ${user.name}`}>
    <div class="profile-container">
        <!-- Profile Banner -->
        <section class="profile-header">
            <div class="profile-cover"></div>
            <div class="profile-info-wrapper">
                <div class="profile-avatar">
                    {user.avatar ? (
                        <img src={user.avatar} alt={user.name} />
                    ) : (
                        <span>{user.name.charAt(0)}</span>
                    )}
                </div>
                <div class="profile-details">
                    <div class="name-row">
                        <h1 class="editable" data-field="name">{user.name}</h1>
                        <span class="badge-role">{user.role}</span>
                    </div>
                    <p class="username">{user.username}</p>
                    <div class="stats-row">
                        <div class="stat">
                            <span class="value">{user.stats.sessions}</span>
                            <span class="label">Sessions</span>
                        </div>
                        <div class="stat">
                            <span class="value">{user.stats.rating} ‚≠ê</span>
                            <span class="label">Rating</span>
                        </div>
                        <div class="stat">
                            <span class="value">{user.stats.students}</span>
                            <span class="label">Students</span>
                        </div>
                    </div>
                </div>
                <div class="profile-actions">
                    <Button id="edit-profile-btn" variant="secondary">Edit Profile</Button>
                    <Button variant="primary">Request Session</Button>
                    <Button variant="ghost" iconOnly aria-label="Message">üí¨</Button>
                </div>
            </div>
        </section>

        <!-- Tabs -->
        <nav class="profile-tabs">
            <button class="tab-btn active" data-tab="about">About Me</button>
            <button class="tab-btn" data-tab="sessions">Sessions</button>
            <button class="tab-btn" data-tab="reviews">Reviews</button>
            <button class="tab-btn" data-tab="settings">Settings</button>
        </nav>

        <!-- Tab Content -->
        <div class="tab-content-container">
            
            <!-- About Section -->
            <section id="about" class="tab-pane active">
                <Card>
                    <h2>Bio</h2>
                    <p class="editable-area" data-field="bio">{user.bio}</p>
                </Card>

                <Card>
                    <h2>Skills</h2>
                    <p class="hint-text">Drag to reorder skills (Enable Edit Mode)</p>
                    <div class="skills-container" id="skills-list">
                        {user.skills.map((skill) => (
                            <div class="skill-tag" draggable="true">
                                {skill}
                                <span class="remove-skill">&times;</span>
                            </div>
                        ))}
                        <button class="add-skill-btn">+ Add Skill</button>
                    </div>
                </Card>

                <Card>
                    <h2>Badges</h2>
                    <div class="badges-grid">
                        {user.badges.map((badge) => (
                            <div class="badge-item">
                                <span class="badge-icon">üèÖ</span>
                                <span>{badge}</span>
                            </div>
                        ))}
                    </div>
                </Card>
            </section>

            <!-- Sessions Section -->
            <section id="sessions" class="tab-pane">
                <Card>
                    <h2>Upcoming Sessions</h2>
                    <div class="session-list">
                        {user.sessions.filter(s => s.status === 'Upcoming').map(session => (
                            <div class="session-item upcoming">
                                <div class="session-date">
                                    <span class="day">{session.date.split('-')[2]}</span>
                                    <span class="month">DEC</span>
                                </div>
                                <div class="session-info">
                                    <h3>{session.title}</h3>
                                    <p>{session.time} ‚Ä¢ {session.type}</p>
                                </div>
                                <Button size="sm">Join</Button>
                            </div>
                        ))}
                    </div>
                </Card>
                <Card>
                    <h2>History</h2>
                    <div class="session-list">
                        {user.sessions.filter(s => s.status === 'Completed').map(session => (
                            <div class="session-item completed">
                                <div class="session-info">
                                    <h3>{session.title}</h3>
                                    <p>{session.date} ‚Ä¢ {session.type}</p>
                                </div>
                                <span class="status-badge">Completed</span>
                            </div>
                        ))}
                    </div>
                </Card>
            </section>

            <!-- Reviews Section -->
            <section id="reviews" class="tab-pane">
                <Card>
                    <h2>Student Feedback</h2>
                    <div class="reviews-list">
                        {user.reviews.map(review => (
                            <div class="review-item">
                                <div class="review-header">
                                    <span class="reviewer-name">{review.user}</span>
                                    <span class="review-date">{review.date}</span>
                                </div>
                                <div class="star-rating">
                                    {"‚òÖ".repeat(review.rating)}{"‚òÜ".repeat(5 - review.rating)}
                                </div>
                                <p class="review-text">{review.comment}</p>
                            </div>
                        ))}
                    </div>
                </Card>
            </section>

            <!-- Settings Section -->
            <section id="settings" class="tab-pane">
                <Card>
                    <h2>Account Settings</h2>
                    <form class="settings-form" onsubmit="event.preventDefault();">
                        <div class="setting-item">
                            <div class="setting-info">
                                <h3>Profile Privacy</h3>
                                <p>Make your profile visible to everyone</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" checked={user.settings.privacy}>
                                <span class="slider round"></span>
                            </label>
                        </div>
                        <div class="setting-item">
                            <div class="setting-info">
                                <h3>Notifications</h3>
                                <p>Receive email updates about sessions</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" checked={user.settings.notifications}>
                                <span class="slider round"></span>
                            </label>
                        </div>
                        <div class="form-actions">
                            <Button variant="primary">Save Changes</Button>
                        </div>
                    </form>
                </Card>
            </section>

        </div>
    </div>
</Layout>

<style lang="scss">
    .profile-container {
        max-width: 1000px;
        margin: 2rem auto 0;
        padding: 0 1rem 4rem;
    }

    /* Header */
    .profile-header {
        background: var(--background);
        border: 1px solid var(--accent-3);
        border-radius: 12px;
        overflow: hidden;
        position: relative;
        margin-bottom: 2rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.03);
    }

    .profile-cover {
        height: 120px;
        width: 100%;
        background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
        opacity: 0.8;
    }

    .profile-info-wrapper {
        padding: 0 2rem 1rem;
        display: flex;
        align-items: flex-start;
        gap: 2rem;
        margin-top: -80px;
        flex-wrap: wrap;
        position: relative;
        z-index: 2;

        @media (max-width: 768px) {
            flex-direction: column;
            align-items: center;
            text-align: center;
            margin-top: -60px;
        }
    }

    .profile-avatar {
        width: 160px;
        height: 160px;
        border-radius: 50%;
        background: var(--background);
        border: 4px solid var(--background);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3rem;
        font-weight: bold;
        color: var(--accent-1);
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        background-color: #eee; /* Fallback */
        flex-shrink: 0;
        overflow: hidden;

        img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
    }

    .profile-details {
        flex: 1;
        padding-bottom: 0.5rem;
        margin-top: 100px; /* 80px to clear cover + 20px padding */

        @media (max-width: 768px) {
            margin-top: 1rem;
            width: 100%;
        }

        .name-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.25rem;
            
            @media (max-width: 768px) {
                justify-content: center;
                flex-direction: column;
                gap: 0.5rem;
            }
        }

        h1 {
            margin: 0;
            font-family: 'Montserrat', sans-serif;
            font-size: 2rem;
            
            &[contenteditable="true"] {
                border-bottom: 2px dashed var(--accent-1);
                outline: none;
            }
        }

        .badge-role {
            background: rgba(44, 116, 196, 0.1);
            color: var(--accent-1);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .username {
            color: var(--foreground);
            opacity: 0.7;
            margin: 0 0 1rem;
        }

        .stats-row {
            display: flex;
            gap: 2rem;
            
            @media (max-width: 768px) {
                justify-content: center;
            }

            .stat {
                display: flex;
                flex-direction: column;
                
                .value { font-weight: bold; font-size: 1.1rem; }
                .label { font-size: 0.85rem; opacity: 0.7; }
            }
        }
    }

    .profile-actions {
        display: flex;
        gap: 1rem;
        padding-bottom: 1rem;
        margin-top: 100px; /* Match profile-details margin */

        @media (max-width: 768px) {
            margin-top: 1rem;
            width: 100%;
            justify-content: center;
        }
    }

    /* Tabs */
    .profile-tabs {
        display: flex;
        gap: 2rem;
        padding: 0 2rem;
        border-bottom: 1px solid var(--accent-3);
        margin-bottom: 2rem;
        overflow-x: auto;

        .tab-btn {
            background: none;
            border: none;
            padding: 1rem 0;
            font-family: 'Montserrat', sans-serif;
            font-size: 1rem;
            color: var(--foreground);
            opacity: 0.6;
            cursor: pointer;
            position: relative;
            white-space: nowrap;

            &.active {
                opacity: 1;
                font-weight: 600;
                color: var(--accent-1);

                &::after {
                    content: '';
                    position: absolute;
                    bottom: -1px;
                    left: 0;
                    width: 100%;
                    height: 2px;
                    background: var(--accent-1);
                }
            }
        }
    }

    /* Content */
    .tab-content-container {
        padding: 0 2rem;
    }

    .tab-pane {
        display: none;
        animation: fadeIn 0.3s ease;

        &.active {
            display: block;
        }
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Skills Drag & Drop */
    .skills-container {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
    }

    .skill-tag {
        background: var(--background);
        border: 1px solid var(--accent-3);
        padding: 0.5rem 1rem;
        border-radius: 8px;
        cursor: grab;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s;

        &:active { cursor: grabbing; }
        
        &.dragging {
            opacity: 0.5;
            border-color: var(--accent-1);
        }

        .remove-skill {
            display: none;
            cursor: pointer;
            color: #e74c3c;
            font-weight: bold;
        }
    }

    .editing .skill-tag .remove-skill {
        display: inline-block;
    }

    .add-skill-btn {
        display: none;
        background: none;
        border: 1px dashed var(--accent-3);
        padding: 0.5rem 1rem;
        border-radius: 8px;
        cursor: pointer;
        color: var(--foreground);
        opacity: 0.7;

        &:hover { border-color: var(--accent-1); color: var(--accent-1); }
    }

    .editing .add-skill-btn {
        display: inline-block;
    }

    .editable-area[contenteditable="true"] {
        border: 1px dashed var(--accent-3);
        padding: 0.5rem;
        border-radius: 4px;
        background: rgba(0,0,0,0.02);
    }

    /* Badges */
    .badges-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 1rem;
    }

    .badge-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem;
        background: rgba(42, 157, 143, 0.1);
        border-radius: 8px;
        font-weight: 500;
    }

    /* Sessions */
    .session-item {
        display: flex;
        align-items: center;
        padding: 1rem;
        border-bottom: 1px solid var(--accent-3);
        gap: 1.5rem;

        &:last-child { border-bottom: none; }

        .session-date {
            text-align: center;
            background: var(--accent-1);
            color: white;
            padding: 0.5rem;
            border-radius: 8px;
            min-width: 60px;

            .day { display: block; font-size: 1.2rem; font-weight: bold; }
            .month { display: block; font-size: 0.7rem; text-transform: uppercase; }
        }

        .session-info {
            flex: 1;
            h3 { margin: 0 0 0.25rem; font-size: 1.1rem; }
            p { margin: 0; font-size: 0.9rem; opacity: 0.7; }
        }

        &.completed .status-badge {
            background: #eee;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
        }
    }

    /* Reviews */
    .review-item {
        padding: 1.5rem 0;
        border-bottom: 1px solid var(--accent-3);
        &:last-child { border-bottom: none; }

        .review-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            
            .reviewer-name { font-weight: 600; }
            .review-date { font-size: 0.85rem; opacity: 0.6; }
        }

        .star-rating {
            color: #f1c40f;
            margin-bottom: 0.5rem;
        }
    }

    /* Settings Switch */
    .setting-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem 0;
        border-bottom: 1px solid var(--accent-3);

        h3 { margin: 0 0 0.25rem; font-size: 1rem; color: var(--foreground); }
        p { margin: 0; font-size: 0.85rem; opacity: 0.7; }
    }

    .switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 26px;

        input { opacity: 0; width: 0; height: 0; }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: .4s;

            &:before {
                position: absolute;
                content: "";
                height: 18px;
                width: 18px;
                left: 4px;
                bottom: 4px;
                background-color: white;
                transition: .4s;
            }

            &.round { border-radius: 34px; &:before { border-radius: 50%; } }
        }

        input:checked + .slider {
            background-color: var(--accent-1);
        }

        input:checked + .slider:before {
            transform: translateX(24px);
        }
    }
</style>

<script>
    // Tab Switching
    const tabs = document.querySelectorAll('.tab-btn');
    const panes = document.querySelectorAll('.tab-pane');

    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            panes.forEach(p => p.classList.remove('active'));

            tab.classList.add('active');
            const target = tab.getAttribute('data-tab');
            document.getElementById(target!)?.classList.add('active');
        });
    });

    // Inline Editing
    const editBtn = document.getElementById('edit-profile-btn');
    const profileContainer = document.querySelector('.profile-container');
    const editableElements = document.querySelectorAll('[data-field]');
    let isEditing = false;

    editBtn?.addEventListener('click', () => {
        isEditing = !isEditing;
        
        if (isEditing) {
            editBtn.textContent = 'Save Changes';
            editBtn.classList.add('primary');
            editBtn.classList.remove('secondary');
            profileContainer?.classList.add('editing');
            
            editableElements.forEach(el => {
                el.setAttribute('contenteditable', 'true');
            });
        } else {
            editBtn.textContent = 'Edit Profile';
            editBtn.classList.add('secondary');
            editBtn.classList.remove('primary');
            profileContainer?.classList.remove('editing');
            
            editableElements.forEach(el => {
                el.setAttribute('contenteditable', 'false');
                // Here you would typically save the data
                console.log(`Saved ${el.getAttribute('data-field')}: ${el.textContent}`);
            });
        }
    });

    // Drag and Drop for Skills
    const skillsList = document.getElementById('skills-list');
    let draggedItem: HTMLElement | null = null;

    if (skillsList) {
        skillsList.addEventListener('dragstart', (e) => {
            if (!isEditing) {
                e.preventDefault(); // Only allow drag when editing
                return;
            }
            const target = e.target as HTMLElement;
            if (target.classList.contains('skill-tag')) {
                draggedItem = target;
                setTimeout(() => target.classList.add('dragging'), 0);
            }
        });

        skillsList.addEventListener('dragend', (e) => {
            const target = e.target as HTMLElement;
            target.classList.remove('dragging');
            draggedItem = null;
        });

        skillsList.addEventListener('dragover', (e) => {
            e.preventDefault();
            const afterElement = getDragAfterElement(skillsList, e.clientY, e.clientX);
            if (draggedItem) {
                if (afterElement == null) {
                    skillsList.appendChild(draggedItem);
                } else {
                    skillsList.insertBefore(draggedItem, afterElement);
                }
            }
        });
    }

    function getDragAfterElement(container: HTMLElement, y: number, x: number) {
        const draggableElements = [...container.querySelectorAll('.skill-tag:not(.dragging)')];

        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            // Simple distance check for grid/flex layout
            const offset = x - box.left - box.width / 2;
            
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY, element: null } as { offset: number, element: Element | null }).element;
    }
</script>
